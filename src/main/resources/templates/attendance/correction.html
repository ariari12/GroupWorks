<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="css">
    <style>
        table.dataTable td, table.dataTable th {
            text-align: center;
        }
    </style>
</th:block>

<th:block layout:fragment="javascript">
    <script src="/js/attendance/datatables.js?v=<%=System.currentTimeMillis() %>"></script>
    <script>

        $(document).ready(function() {
            function loadAttendanceData(month) {
                $.ajax({
                    url: '/api/commute/list',
                    data: { month: month },
                    success: function(data) {
                        var tbody = $('#datatablesCommute tbody');
                        tbody.empty(); // ê¸°ì¡´ ë°ì´í„°ë¥¼ ì§€ìš°ê³  ìƒˆ ë°ì´í„°ë¡œ ì±„ì›€

                        data.forEach(function(item) {
                            var row = `<tr>
                                <td>${item.formattedDate}</td>
                                <td>${item.formattedStartTime}</td>
                                <td>${item.formattedEndTime}</td>
                                <td>${item.workHours}</td>
                                <td>${item.overtimeHours}</td>
                                <td>${item.status}</td>
                            </tr>`;
                            tbody.append(row);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", status, error);
                    }
                });

                function attendanceData() {
                    let date = $('#monthYearPicker').val();
                    $.ajax({
                        url: '/api/commute/list?month' + date,
                        data: {month: month},
                        success: function (data) {
                            var tbody = $('#datatablesCommute tbody');
                            tbody.empty(); // ê¸°ì¡´ ë°ì´í„°ë¥¼ ì§€ìš°ê³  ìƒˆ ë°ì´í„°ë¡œ ì±„ì›€
                            data.forEach(function (item) {
                                var row = `<tr>
                                <td>${item.formattedDate}</td>
                                <td>${item.formattedStartTime}</td>
                                <td>${item.formattedEndTime}</td>
                                <td>${item.workHours}</td>
                                <td>${item.overtimeHours}</td>
                                <td>${item.status}</td>
                            </tr>`;
                                tbody.append(row);
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", status, error);
                        }
                    });
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì›”ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            var currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM í˜•ì‹
            loadAttendanceData(currentMonth);

            // ë‚ ì§œ ì„ íƒê¸° ì„¤ì •
            flatpickr("#monthYearPicker", {
                locale: "ko", // í•œêµ­ì–´ ì„¤ì •
                plugins: [
                    new monthSelectPlugin({
                        shorthand: true, // ì›”ì„ ì§§ê²Œ í‘œì‹œ
                        dateFormat: "Y-m", // í˜•ì‹ YYYY-MM
                        altFormat: "Yë…„ F", // í‘œì‹œ í˜•ì‹ Month YYYY
                    })
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    loadAttendanceData(dateStr); // ë‚ ì§œ ì„ íƒ ì‹œ í•´ë‹¹ ì›”ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                }
            });

            // ìˆ˜ì • ì‹œì‘ì‹œê°„.
            flatpickr("#startTimepicker", {
                locale: "ko",                    // í•œêµ­ì–´ ì„¤ì •,
                enableTime: true,                // ì‹œê°„ ì„ íƒ í™œì„±í™”
                dateFormat: "Y-m-d H:i",         // ë‚ ì§œ ë° ì‹œê°„ í˜•ì‹ ì„¤ì •
                time_24hr: true,                 // 24ì‹œê°„ í˜•ì‹ ì‚¬ìš© (12ì‹œê°„ í˜•ì‹ì„ ì›í•˜ë©´ falseë¡œ ì„¤ì •)
                minuteIncrement: 1               // ë¶„ ì„ íƒ ê°„ê²© ì„¤ì • (1ë¶„ ë‹¨ìœ„ë¡œ ì„ íƒ ê°€ëŠ¥)
            });

            // ìˆ˜ì • ì¢…ë£Œ ì‹œê°„.
            flatpickr("#endTimepicker", {
                locale: "ko",                    // í•œêµ­ì–´ ì„¤ì •,
                enableTime: true,                // ì‹œê°„ ì„ íƒ í™œì„±í™”
                dateFormat: "Y-m-d H:i",         // ë‚ ì§œ ë° ì‹œê°„ í˜•ì‹ ì„¤ì •
                time_24hr: true,                 // 24ì‹œê°„ í˜•ì‹ ì‚¬ìš© (12ì‹œê°„ í˜•ì‹ì„ ì›í•˜ë©´ falseë¡œ ì„¤ì •)
                minuteIncrement: 1               // ë¶„ ì„ íƒ ê°„ê²© ì„¤ì • (1ë¶„ ë‹¨ìœ„ë¡œ ì„ íƒ ê°€ëŠ¥)
            });

            // ê·¼ë¬´ì¶”ê°€ ë²„íŠ¼ í´ë¦­.
            $("#addWork").on('click', function () {

                // ì…ë ¥ëœ ê·¼íƒœ ì‹œê°.
                let startDate = $("#startTimepicker").val()
                let endDate = $("#endTimepicker").val()

                // ìœ íš¨ì„± ê²€ì‚¬.
                if (!startDate || !startDate.trim()) {
                    alert("ê·¼ë¬´ ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                } else if (!endDate || !endDate.trim()) {
                    alert("ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                } else if (startDate >= endDate) {
                    alert("ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„ì´ ê·¼ë¬´ ì‹œì‘ì‹œê°„ë³´ë‹¤ ë¹ ë¦„ë‹ˆë‹¤.");
                    return;
                }

                // ì„œë²„ì— ì „ì†¡ë  ë°ì´í„°.
                const requestData = {
                    'startDate': startDate,  // ì‹œì‘ ì‹œê°„
                    'endDate': endDate       // ì¢…ë£Œ ì‹œê°„
                };

                // ê·¼íƒœ ì¶”ê°€ ì‹ ì²­.
                $.ajax({
                    url: '/api/commute/add-requests',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        alert("ê·¼íƒœ ì¶”ê°€ ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        console.log(response);
                    },
                    error: function (xhr, status, error) {
                        alert(`ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${xhr.responseText || error}`);
                    }
                }); // end ajax
            });
        });


    </script>
</th:block>

<th:block layout:fragment="content">
    <div class="card mb-4" th:fragment="tables">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            7ì›” ì¶œê·¼ ë°ì´í„°
            <div class="container mt-3">
                <div class="row">
                    <form id="dataForm" method="post">
                        <div class="col-md-4">
                            <label for="monthYearPicker">ë°ì´í„°ì¡°íšŒ : </label>
                            <input type="text" id="monthYearPicker" class="form-control"/>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                ê·¼ë¬´ì¶”ê°€
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ê·¼ë¬´ì¶”ê°€ -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">ê·¼ë¬´ ì¶”ê°€</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div style="margin: 5px;"><span>â° ì¶œê·¼ì‹œê° </span><input type="text" class="w-100%" id="startTimepicker"/></div>
                        <div style="margin: 5px;"><span>ğŸ•” í‡´ê·¼ì‹œê° </span><input type="text" class="w-100%" id="endTimepicker"/></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="addWork" class="btn btn-primary">ì¶”ê°€</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="card-body">
            <table id="datatablesCommute" class="table table-hover" style="width:100%">
                <thead>
                <tr>
                    <th>ğŸ“…ë‚ ì§œ</th>
                    <th>â°ì¶œê·¼ì‹œê°</th>
                    <th>ğŸ•”í‡´ê·¼ì‹œê°</th>
                    <th>â³ê·¼ë¬´ì‹œê°„</th>
                    <th>â±ï¸ì´ˆê³¼ê·¼ë¬´ì‹œê°„</th>
                    <th>ğŸ“ƒìƒíƒœ</th>
                </tr>
                </thead>

                <tbody>

                </tbody>
            </table>
        </div>
    </div>
</th:block>